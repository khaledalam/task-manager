<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</head>
<body class="bg-light p-4">
<div class="container">
  <h2 class="mb-4 text-center">üìù Task Manager</h2>

  <!-- Filter & Search -->
  <div class="row mb-3">
    <div class="col-md-2">
      <select class="form-select" id="filterStatus">
        <option value="">All Statuses</option>
        <option>pending</option>
        <option>in_progress</option>
        <option>completed</option>
      </select>
    </div>
    <div class="col-md-2">
      <select class="form-select" id="filterPriority">
        <option value="">All Priorities</option>
        <option>low</option>
        <option>medium</option>
        <option>high</option>
      </select>
    </div>
    <div class="col-md-4">
      <input type="text" class="form-control" id="searchInput" placeholder="Search by title">
    </div>
    <div class="col-md-2">
      <select class="form-select" id="sortBy">
        <option value="created_at">Sort: Created At</option>
        <option value="due_date">Due Date</option>
        <option value="priority">Priority</option>
      </select>
    </div>
    <div class="col-md-2">
      <button class="btn btn-primary w-100" onclick="loadTasks()">Apply</button>
    </div>
  </div>

  <!-- Task List -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <ul class="list-group" id="taskList"></ul>
    </div>
  </div>

  <!-- Task Form -->
  <div class="card shadow-sm">
    <div class="card-header">Create / Edit Task</div>
    <div class="card-body">
      <form id="taskForm">
        <input type="hidden" name="id" id="taskId">
        <div class="mb-3">
          <label class="form-label">Title</label>
          <input name="title" class="form-control" required minlength="5">
        </div>
        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" class="form-control"></textarea>
        </div>
        <div class="row mb-3">
          <div class="col">
            <label class="form-label">Status</label>
            <select name="status" class="form-select">
              <option>pending</option>
              <option>in_progress</option>
              <option>completed</option>
            </select>
          </div>
          <div class="col">
            <label class="form-label">Priority</label>
            <select name="priority" class="form-select">
              <option>low</option>
              <option selected>medium</option>
              <option>high</option>
            </select>
          </div>
          <div class="col">
            <label class="form-label">Due Date</label>
            <input type="date" name="due_date" class="form-control">
          </div>
        </div>
        <button type="submit" class="btn btn-success">Save Task</button>
        <button type="button" class="btn btn-secondary" onclick="resetForm()">Clear</button>
      </form>
      <div class="alert mt-3 d-none" id="formMessage"></div>
    </div>
  </div>
</div>

<!-- View Task Modal -->
<div class="modal fade" id="viewTaskModal" tabindex="-1" aria-labelledby="viewTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-sm">
      <div class="modal-header">
        <h5 class="modal-title" id="viewTaskModalLabel">Task Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Title:</strong> <span id="modalTaskTitle"></span></p>
        <p><strong>Description:</strong> <span id="modalTaskDescription"></span></p>
        <p><strong>Status:</strong> <span id="modalTaskStatus" class="badge"></span></p>
        <p><strong>Priority:</strong> <span id="modalTaskPriority" class="badge"></span></p>
        <p><strong>Due Date:</strong> <span id="modalTaskDueDate"></span></p>
        <p><strong>Created:</strong> <span id="modalTaskCreated"></span></p>
      </div>
    </div>
  </div>
</div>


<script>
  function viewTask(task) {
    document.getElementById('modalTaskTitle').textContent = task.title || '';
    document.getElementById('modalTaskDescription').textContent = task.description || '';
    document.getElementById('modalTaskStatus').textContent = task.status || '';
    document.getElementById('modalTaskPriority').textContent = task.priority || '';
    document.getElementById('modalTaskDueDate').textContent = task.due_date || 'N/A';
    document.getElementById('modalTaskCreated').textContent = task.created_at || 'N/A';

    const statusBadge = document.getElementById('modalTaskStatus');
    statusBadge.className = 'badge';
    if (task.status === 'pending') statusBadge.classList.add('bg-secondary');
    else if (task.status === 'in_progress') statusBadge.classList.add('bg-warning');
    else if (task.status === 'completed') statusBadge.classList.add('bg-success');

    const priorityBadge = document.getElementById('modalTaskPriority');
    priorityBadge.className = 'badge';
    if (task.priority === 'low') priorityBadge.classList.add('bg-secondary');
    else if (task.priority === 'medium') priorityBadge.classList.add('bg-info');
    else if (task.priority === 'high') priorityBadge.classList.add('bg-danger');

    const modal = new bootstrap.Modal(document.getElementById('viewTaskModal'));
    modal.show();
  }


  async function loadTasks() {
    const status = document.getElementById('filterStatus').value;
    const priority = document.getElementById('filterPriority').value;
    const q = document.getElementById('searchInput').value;
    const sort = document.getElementById('sortBy').value;

    const params = { status, priority, q, sort, order: 'desc', limit: 50 };
    const res = await axios.get('/tasks', { params });
    const list = document.getElementById('taskList');
    list.innerHTML = '';

    (res.data.items || res.data).forEach(task => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.innerHTML = `
    <div>
      <strong>${task.title}</strong>
      <div class="text-muted small">${task.description || ''}</div>
    </div>
    <div>
      <button class="btn btn-sm btn-outline-info me-1" onclick='viewTask(${JSON.stringify(task)})'>View</button>
      <button class="btn btn-sm btn-outline-primary me-1" onclick='editTask(${JSON.stringify(task)})'>Edit</button>
      <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})">Delete</button>
    </div>
  `;
      list.appendChild(li);
    });
  }

  async function deleteTask(id) {
    if (!confirm("Delete this task?")) return;
    await axios.delete(`/tasks/${id}`);
    loadTasks();
  }

  function editTask(task) {
    document.getElementById('taskId').value = task.id;
    document.querySelector('[name="title"]').value = task.title;
    document.querySelector('[name="description"]').value = task.description;
    document.querySelector('[name="status"]').value = task.status;
    document.querySelector('[name="priority"]').value = task.priority;
    document.querySelector('[name="due_date"]').value = task.due_date;
  }

  function resetForm() {
    document.getElementById('taskForm').reset();
    document.getElementById('taskId').value = '';
    document.getElementById('formMessage').classList.add('d-none');
  }

  document.getElementById('taskForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    const form = e.target;
    const data = Object.fromEntries(new FormData(form).entries());

    const id = data.id;
    delete data.id;

    try {
      if (id) {
        await axios.put(`/tasks/${id}`, data);
        showMessage("Task updated ‚úÖ", 'success');
      } else {
        await axios.post('/tasks', data);
        showMessage("Task created ‚úÖ", 'success');
      }
      resetForm();
      loadTasks();
    } catch (err) {
      const msg = err?.response?.data?.errors
              ? Object.values(err.response.data.errors).flat().join('<br>')
              : '‚ùå Unknown error';
      showMessage(msg, 'danger');
    }
  });

  function showMessage(msg, type) {
    const box = document.getElementById('formMessage');
    box.innerHTML = msg;
    box.className = `alert alert-${type}`;
    box.classList.remove('d-none');
  }

  // Initial Load
  loadTasks();
</script>
</body>
</html>
